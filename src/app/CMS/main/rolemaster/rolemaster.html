<div class="card">
  <p-table #dt 
           [value]="roles" 
           dataKey="roleID" 
           [rows]="10" 
           [rowsPerPageOptions]="[10, 25, 50]" 
           [loading]="loading" 
           [paginator]="true" 
           [globalFilterFields]="['roleName']" 
           [showGridlines]="true"
           styleClass="p-datatable-sm">

    <ng-template pTemplate="caption">
      <div style="display:flex; align-items:center; width:100%;">
          <h1 style="margin:0; font-size:1.75rem; font-weight:700;">Role Master</h1>
          <div style="margin-left:auto;">
              <p-button label="Add New Role" icon="pi pi-plus" class="p-button-success" (click)="openNew()">
              </p-button>
          </div>
      </div>

      <div class="flex mt-3">
        <p-iconField iconPosition="left" class="ml-auto">
          <p-inputIcon>
            <i class="pi pi-search"></i>
          </p-inputIcon>
          <input pInputText 
                 type="text" 
                 (input)="dt.filterGlobal($event.target.value, 'contains')" 
                 placeholder="Search roles..." />
        </p-iconField>
      </div>
    </ng-template>

    <!-- Table Header -->
    <ng-template pTemplate="header">
      <tr>
        <!-- <th style="width: 3.5rem">
          <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
        </th> -->
        <th style="min-width: 16rem">
          <div class="flex align-items-center justify-content-between">
            Role Name
            <p-columnFilter type="text" field="roleName" display="menu"></p-columnFilter>
          </div>
        </th>
        <th style="min-width: 10rem">
          <div class="flex align-items-center justify-content-between">
            Status
            <p-columnFilter field="isActive" matchMode="equals" display="menu">
              <ng-template pTemplate="filter" let-filter="filterCallback">
                <p-select [options]="[
                    { label: 'All', value: null },
                    { label: 'Active', value: true },
                    { label: 'Inactive', value: false }
                  ]" 
                  (onChange)="filter($event.value)" 
                  placeholder="All">
                </p-select>
              </ng-template>
            </p-columnFilter>
          </div>
        </th>
        <th style="min-width: 12rem">
          Permissions
        </th>
        <th style="width: 8rem">Actions</th>
      </tr>
    </ng-template>

    <!-- Table Body -->
    <ng-template pTemplate="body" let-role>
      <tr>
        <!-- <td>
          <p-tableCheckbox [value]="role"></p-tableCheckbox>
        </td> -->
        <td>
          <div class="flex align-items-center gap-3">
            <div class="border-round surface-200 flex align-items-center justify-content-center" style="width: 2.5rem; height: 2.5rem;">
              <i class="pi pi-user text-primary"></i>
            </div>
            <span class="font-medium">{{ role.roleName }}</span>
          </div>
        </td>
        <td>
          <p-tag 
            [value]="role.isActive ? 'Active' : 'Inactive'"
            [severity]="role.isActive ? 'success' : 'danger'"
            class="text-sm">
          </p-tag>
        </td>
        <td>
          <span class="text-600 text-sm">{{ role.permissions.length }} permissions</span>
        </td>
        <td>
          <div class="flex gap-2">
            <button pButton 
                    icon="pi pi-pencil" 
                    class="p-button-rounded p-button-text p-button-info" 
                    pTooltip="Edit" 
                    (click)="editRole(role)">
            </button>
            <button pButton 
                    icon="pi pi-trash" 
                    class="p-button-rounded p-button-text p-button-danger" 
                    pTooltip="Delete" 
                    (click)="deleteRole(role)">
            </button>
          </div>
        </td>
      </tr>
    </ng-template>

    <!-- Empty State -->
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="5" class="text-center py-6 text-600">
          <i class="pi pi-inbox text-4xl mb-3"></i>
          <div class="text-lg">No roles found</div>
          <p-button label="Add First Role" icon="pi pi-plus" class="mt-3 p-button-success" (click)="openNew()"></p-button>
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>
  <!-- Role + Permissions Dialog -->
  <p-dialog [(visible)]="displayDialog" [header]="roleDialogHeader" [modal]="true"
            [style]="{width: '90vw', maxWidth: '900px'}" [resizable]="true">

    <div class="row">
      <div class="col-md-5">
        <div class="mb-4">
          <label class="form-label fw-medium">Role Name <span class="text-danger">*</span></label>
          <input pInputText [(ngModel)]="currentRole.roleName" class="form-control"
                 [class.is-invalid]="!currentRole.roleName" placeholder="e.g. Administrator"/>
          <div class="invalid-feedback">Role name is required</div>
        </div>

        <div class="mb-4">
          <label class="form-label fw-medium">Status</label>
          <div class="d-flex align-items-center gap-3">
            <p-inputSwitch [(ngModel)]="currentRole.isActive"></p-inputSwitch>
            <span>{{ currentRole.isActive ? 'Active' : 'Inactive' }}</span>
          </div>
        </div>
      </div>

      <div class="col-md-7">
        <h6 class="fw-semibold mb-3">Permissions</h6>
        <div class="row g-3">
          <div class="col-6" *ngFor="let module of permissionModules">
            <div class="border rounded p-3 bg-white">
              <small class="text-muted d-block mb-2 fw-medium">{{ module.name }}</small>
              <div class="d-flex flex-wrap gap-3">
                <div class="form-check" *ngFor="let action of module.actions">
                  <input class="form-check-input" type="checkbox"
                         [id]="'perm-' + module.key + '-' + action.key"
                         [(ngModel)]="currentRole.permissionsMap[module.key + ':' + action.key]"
                         (ngModelChange)="updatePermissionsArray()">
                  <label class="form-check-label small" [for]="'perm-' + module.key + '-' + action.key">
                    {{ action.label }}
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <button pButton label="Cancel" icon="pi pi-times" class="p-button-text"
              (click)="displayDialog = false"></button>
      <button pButton label="Save Role" icon="pi pi-check" [loading]="saving"
              [disabled]="!currentRole.roleName"
              class="p-button-success" (click)="saveRole()"></button>
    </ng-template>
  </p-dialog>

  <p-confirmDialog></p-confirmDialog>
